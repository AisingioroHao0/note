# TCP

## 报文信息

源端口号                                                                                             目的端口号

​                                                          序号

​                                                        确认号

首部长度 保留未 控制位（URG，ACL，PSH，RST，SYN，FIN）   接收窗口

校验和                                                                                             紧急数据指针

​                                                          选项

​                                                          数据



- 控制位

  - URG

    为1时紧急指针有效

  - ACK

    成功接收报文段的确认

  - PUSH

    为1时接收方收到该报文段应立刻交给应用程序，而不是在缓冲区排队

  - RST

    重置链接的标志

  - SYN

    同步序号，建立连接时使用

  - FIN

    释放连接

## 保证可靠性

- 数据分块

- 序列号和确认应答

- 校验和

  二进制反码求和

- 流量控制

  滑动窗口

- 拥塞控制

- ARQ协议

- 重传

  - 超时重传

    当规定时间内没有收到确认就要重传已发送的报文段。

    采用自适应算法动态改变重传时间（加权平均往返时间）。

  - 快速重传

    冗余ACK，当收到三个对于报文段的ACK，则立马重传该报文段 

## 定时器

- 建立连接定时器

  当发送SYN时启动

- 重传定时器

  超时重传机制，发送报文段后启动，当没有收到ACK报文时重传

- 坚持计时器

  避免因为接受窗口满时一直等待

- 延迟应答计时器

  等一段时间再应答，连带发送数据捎带应答

- 保活计时器

  建立连接时指定SO_KEEPLIVE时才会生效，确定对端还或者

- FIN_WAIT_2定时器

  避免主动关闭一方一直陷入等待，超时时立刻释放连接

- TIME_WAIT定时器

  发送方最后一次挥手，避免关闭方没有收到ACK

## 流量控制

接收方设置确认报文的接受窗口字段。

发送方的发送窗口取决于窗口rwnd和拥塞窗口的最小值。

连接的一方收到对方的零窗口通知，就会启动计时器，计时器终止则发送一个**零窗口探测报文段**，接收方收到**零窗口探测报文**就会给出现在的窗口值。

### 拥塞控制

单位最大报文段长度MSS

- 慢开始

  小于ssthresh式，cwnd*=2；

- 拥塞避免

  大于ssthresh时，cwnd++；

- 快重传

  收到三次重复确认立刻重传

- 快恢复

  当发送方接收到三个重复确认，慢开始门限ssthresh值减半

## 粘包与拆包问题

### 原因

- 发送方写入的数据大于套接字缓冲区大小，将发生拆包
- 发送方写入的数据小于套接字缓冲区大小，只有当收到一个确认后，才将分组发送给对端，当发送方收集了多个较小的分组，一起发送给对方将产生粘包
- 进行MSS（最大报文长度）大小的TCP分段，当TCP报文的数据部分大于MSS时会拆包
- 发送方发送的数据太快，接收方处理数据的速度赶不上发送端的数据

### 解决办法

- 在消息头部添加消息长度字段
- 固定消息数据长度
- 设置消息边界

