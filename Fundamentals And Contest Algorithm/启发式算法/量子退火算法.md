# 量子退火算法

模拟退货的温度参数可以类比量子退火的“隧道场强度”

必须把问题映射成一个叫哈密顿算符（Hamiltonian）的能量表达式，一般用H表示，然后求出让H值最小的变量组合。这个表达式是个二次多项式，里面的变量只能取0或1.

## QUBO

求解一个优化问题，二次无约束二值优化，假设令$H=x_1^2+x_2^2+x^3_3-1$

可以写成
$$
H=(x_1,x_2,x_3)
\begin{pmatrix}
1&0&0\\
0&1&0\\
0&0&1
\end{pmatrix}
\begin{pmatrix}
x_1\\
x_2\\
x_3
\end{pmatrix}-2
$$
中间这个数字矩阵即QUBO（Quadratic Unconstrained Binary Optimization）矩阵，即二次无约束二值优化

因此可以将所有的目标函数都写成下面形式
$$
H=\sum_{i<j}Q_{ij}x_ix_j+\sum_ih_ix_i
$$

## Ising模型

论文中的Ising模型是一种表现热力学相变的简单模型，有N个自旋的系统总能量为：
$$
H(\sigma)=-\sum_{i=1}^NJ_{ij}\sigma_i\sigma_j-\sum_ih_i\sigma_i
$$

- $h_i$表示$\sigma_i$的磁场强度，符号表示了向上自旋还是向下自旋
- $J_{i,j}$表示$\sigma_i,\sigma_j$的相互作用强度



参照QUBO可以看出，$\sigma$即对应我们一般优化问题的变量x，J，h则需要分别表示目标函数的规则，但是$\sigma_i \in \{1,-1\}$，N即N个自变量

## 模拟量子退火（SQA）

推广Ising模型到m+1维度，M为复制体数量，这个系统期望有最小的能量
$$
H(\sigma)=-\sum_{k=1}^M\left(\sum_{i<j}\frac{J_{i,j}}{M}\sigma_{i,k}\sigma_{j,k}+\sum_i \frac{h_i}{M}\sigma_{i,k}+J^*\sum_i \sigma_{i,k}\sigma_{i,k+1}\right)
$$

- $J^*=\frac{T}{2}*\ln(coth(\Gamma(t)/(MT)))$

  - $coth(x)=cosh(x) / sinh(x) = (e^x + e^{-x}) / (e^x - e^{-x})$
  - $cosh(x) = (e^x + e^{-x}) / 2$
  - $sinh(x) = (e^x - e^{-x}) / 2$

  - $\Gamma(t)=1 + s * t / T$为控制反转场,负责将时间参数t映射到$[1,\infty]$的区间，s为一个常数，T为总时间数

    

可以看到该函数包含了原始目标函数的一部分，多维采用了相加每个维度求平均的方式，并引入了新的项来赋予自变量穿梭到其他单调区间寻找最小值的能力

为此构造三个矩阵

- Coupling matrix（耦合矩阵）

  目标函数系数，$J_{i,j}$代表是$x_ix_j$项的系数

  ![image-20230425141953083](./%E9%87%8F%E5%AD%90%E9%80%80%E7%81%AB%E7%AE%97%E6%B3%95.assets/image-20230425141953083.png)

- Spin matrix（自旋矩阵）

  自变量矩阵$\sigma_{i,j}$代表第i个变量x第m维度的值

  ![image-20230425142048086](./%E9%87%8F%E5%AD%90%E9%80%80%E7%81%AB%E7%AE%97%E6%B3%95.assets/image-20230425142048086.png)

- Local-field matrix（局部能量矩阵）

  提前存好部分另一部分乘积
  $$
  local\_field_{i,m}=\sum_{j=1}^NJ_{i,j}\sigma_{j,m}
  $$
  $local\_field_{i,m}$代表第m维下，损失函数中$x_i$的贡献，这一部分$x_{i,m}(\sum_{j=1}^Nx_{j,m})$

  ![image-20230425142107987](./%E9%87%8F%E5%AD%90%E9%80%80%E7%81%AB%E7%AE%97%E6%B3%95.assets/image-20230425142107987.png)

有了以上定义，在模拟退火中，计算$\Delta H=\sigma_{i,m}(local\_field_{i,m}-J^*(\sigma_{i,m+1}+\sigma_{i,m-1}))$

然后根据此得出的概率更新自变量

![image-20230425145041091](./%E9%87%8F%E5%AD%90%E9%80%80%E7%81%AB%E7%AE%97%E6%B3%95.assets/image-20230425145041091.png)

显然自变量更新后，损失函数$x_i$的贡献变化，需要更新

![image-20230425145056878](./%E9%87%8F%E5%AD%90%E9%80%80%E7%81%AB%E7%AE%97%E6%B3%95.assets/image-20230425145056878.png)

整体算法描述如下

![image-20230425145123710](./%E9%87%8F%E5%AD%90%E9%80%80%E7%81%AB%E7%AE%97%E6%B3%95.assets/image-20230425145123710.png)

定义问题的哈密顿量：将问题转换为哈密顿量的形式，并将其表示为量子比特之间的相互作用。哈密顿量可以看作是一个能量函数，其最小值对应于问题的最优解。![image-20230425154415472](./%E9%87%8F%E5%AD%90%E9%80%80%E7%81%AB%E7%AE%97%E6%B3%95.assets/image-20230425154415472.png)

- 制备量子态：将哈密顿量作用于一组量子比特的初始状态，得到一个量子态。初始状态可以是一个简单的量子态，例如所有比特都处于0态，或者是一个随机的量子态。
- 量子随机游走：通过量子随机游走来寻找最小能量状态。量子随机游走是一种基于量子隧穿效应的随机演化过程，可以在量子态中搜索最小能量状态。在演化过程中，系统会从初始状态开始，通过量子隧穿效应，逐渐转移到更低能量的状态。
- 退火调度：在演化过程中，通过温度参数来控制演化速度，从而避免陷入局部极小值。通常，温度参数随时间逐渐降低，使系统趋向于稳定状态。
- 量子测量：在退火过程结束后，通过量子测量来得到最终的量子态，并将其转换为经典比特的形式。最终的经典比特表示了问题的最优解。

## Tensor Core

Tensor Core是英伟达面向深度学习应用的矩阵计算加速器。可以在每个时钟周期对4*4矩阵执行矩阵乘法和累加。

在局部能量更新时涉及大量矩阵运算，通过NVIDIA cuBLAS库可以在Tensor Core上进行编程，这些运算可以在张量核上进行。
